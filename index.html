<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mercedes-benz Stardust</title>
    <link rel="stylesheet" href="style/css/style.css">
    <link rel="stylesheet" href="style/css/main.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="js/queue.js"></script>
</head>
<body>
<div class="main">
    <!--<div class="stars rotate">-->
    <!--<div class="star star-l-1"></div>-->
    <!--<div class="star star-l-2"></div>-->
    <!--</div>-->
    <!-- Global Background -->
    <canvas id="stardust" class="z-0"></canvas>
    <!-- /Global Background -->

    <!-- Mask -->
    <div class="mask z-2"></div>
    <!-- /Mask -->

    <!-- Main icon -->
    <div class="big-icon z-4"></div>
    <!-- /Main icon -->
</div>
<div>No one stands at the beginning of the sky, whether you or me, including God, but from now on, I stand by the
    horizon
</div>
<script>
    // init
    (function (global) {
        global.__ACTIONS__ = {};
        global.__RESOURCE__ = {};
        global.__QUEUE__ = {};
    })(window);

    var DD = (function () {
        var _C = {};
        return function (name) {
            if (_C[name] == null) {
                _C[name] = +new Date;
                console.log(name + ' >>>');
            } else {
                console.log(name + ' <<< [' + (+new Date - _C[name]) + 'ms]');
            }
        }
    })()
</script>
<script>
    (function (global, $) {
        var ACT = global.__ACTIONS__;
        ACT.loadData = function (cb) {
            DD('__ACTIONS__.loadData');
            $.get('data/resource.json', function (ret) {
                global.__RESOURCE__.originImages = ret.images;
                DD('__ACTIONS__.loadData');
                $.isFunction(cb) && cb();
            });
        };
    })(window, jQuery);
</script>
<script>
    (function (global, $) {

        var ACT = global.__ACTIONS__;

        ACT.loadResource = function (cb) {
            DD('__ACTIONS__.loadResource');
            var IMAGES = global.__RESOURCE__.IMAGES = {};
            var imgs = global.__RESOURCE__.originImages;
            var q = new queue();
            for (var name in imgs) {
                if (imgs.hasOwnProperty(name)) {
                    q.defer(loadIMG, name, imgs[name]);
                }
            }
            q.awaitAll(function () {
                DD('__ACTIONS__.loadResource');
                $.isFunction(cb) && cb();
            });

            function loadIMG(name, url, cb) {
                var img = new Image();
                img.onload = function () {
                    IMAGES[name] = img;
                    img.onload = null;
                    img = null;
                    $.isFunction(cb) && cb();
                };
                img.src = url;
            }
        };

    })(window, jQuery);
</script>
<script>
    (function (global, $) {

        var ACT = global.__ACTIONS__;

        ACT.hideMask = function (cb) {
            DD('__ACTIONS__.hideMask');
            $('.mask').animate({
                opacity: 0
            }, 1000);
            DD('__ACTIONS__.hideMask');
            $.isFunction(cb) && cb();
        };

    })(window, jQuery);
</script>
<script>
    (function (global, $) {

        var ACT = global.__ACTIONS__;

        ACT.stageRender = function (cb) {
            DD('__ACTIONS__.stageRender');

            var bgi = global.__RESOURCE__.IMAGES.main,
                    bgiWidth = bgi.width,
                    bgiHeight = bgi.height;

            var canvas = document.getElementById('stardust'),
                    ctx = canvas.getContext('2d'),
                    w = canvas.width = window.innerWidth,
                    h = canvas.height = window.innerHeight * 2,

                    hue = 217,
                    stars = [],
                    count = 0,
                    maxStars = 2000;

            // auto scale
            var scale = Math.min(bgiWidth / w, bgiHeight / (h / 2));
            bgiWidth /= scale;
            bgiHeight /= scale;
            var bgiX = (w - bgiWidth) / 2;
            var bgiY = (h / 2 - bgiHeight);

            // Thanks @jackrugile for the performance tip! http://codepen.io/jackrugile/pen/BjBGoM
            // Cache gradient
            var canvas2 = document.createElement('canvas'),
                    ctx2 = canvas2.getContext('2d');

            canvas2.width = 100;
            canvas2.height = 100;
            var half = canvas2.width / 2;
            var gradient2 = ctx2.createRadialGradient(half, half, 0, half, half, half);
            gradient2.addColorStop(0.025, '#fff');
            gradient2.addColorStop(0.1, 'hsl(' + hue + ', 100%, 100%)');
            gradient2.addColorStop(0.25, 'hsl(' + hue + ', 64%, 6%)');
            gradient2.addColorStop(1, 'transparent');

            ctx2.fillStyle = gradient2;
            ctx2.beginPath();
            ctx2.arc(half, half, half, 0, Math.PI * 2);
            ctx2.fill();

            // End cache

            function random(min, max) {
                if (arguments.length < 2) {
                    max = min;
                    min = 0;
                }

                if (min > max) {
                    var hold = max;
                    max = min;
                    min = hold;
                }

                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function maxOrbit(x, y) {
                var max = Math.max(x, y),
                        diameter = Math.round(Math.sqrt(max * max + max * max));
                return diameter / 2;
            }

            var Star = function () {

                this.orbitRadius = random(maxOrbit(w, h));
                this.radius = random(60, this.orbitRadius) / 30;
                this.orbitX = w / 2;
                this.orbitY = h / 2;
                this.timePassed = random(0, maxStars);
                this.speed = random(this.orbitRadius) / 2000000;
                this.alpha = random(2, 10) / 10;

                count++;
                stars[count] = this;
            }

            Star.prototype.draw = function () {
                var x = Math.sin(this.timePassed) * this.orbitRadius + this.orbitX,
                        y = Math.cos(this.timePassed) * this.orbitRadius + this.orbitY,
                        twinkle = random(10);

                if (twinkle === 1 && this.alpha > 0) {
                    this.alpha -= 0.05;
                } else if (twinkle === 2 && this.alpha < 1) {
                    this.alpha += 0.05;
                }

                ctx.globalAlpha = this.alpha;
                ctx.drawImage(canvas2, x - this.radius / 2, y - this.radius / 2, this.radius, this.radius);
                this.timePassed += this.speed;
            }

            for (var i = 0; i < maxStars; i++) {
                new Star();
            }

            function animation() {
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 0.8;
                // ctx.fillStyle = 'hsla(' + hue + ', 64%, 6%, 1)';
                // ctx.fillRect(0, 0, w, h);
                ctx.drawImage(bgi, bgiX, bgiY, bgiWidth, bgiHeight);
                ctx.globalCompositeOperation = 'lighter';
                for (var i = 1, l = stars.length; i < l; i++) {
                    stars[i].draw();
                }

                window.requestAnimationFrame(animation);
            }

            animation();

            DD('__ACTIONS__.stageRender');
            $.isFunction(cb) && cb();

        }

    })(window, jQuery);
</script>
<script>
    (function (global) {

        global.__QUEUE__.start = function () {
            global.__QUEUE__.dataQueue();
        }

        global.__QUEUE__.dataQueue = function () {
            var q = new queue();
            q.defer(global.__ACTIONS__.loadData);
            q.awaitAll(function () {
                global.__QUEUE__.resourceQueue();
            });
        }

        global.__QUEUE__.resourceQueue = function () {
            var q = new queue();
            q.defer(global.__ACTIONS__.loadResource);
            q.awaitAll(function () {
                setTimeout(function () {
                    global.__QUEUE__.stageRenderQueue();
                }, 1000);
            });
        }

        global.__QUEUE__.stageRenderQueue = function () {
            var q = new queue();
            q.defer(global.__ACTIONS__.stageRender);
            q.defer(global.__ACTIONS__.hideMask);
            q.awaitAll(function () {
                console.log(global.__RESOURCE__);
            });
        }

        global.__QUEUE__.start();
    })(window);

</script>
</body>
</html>